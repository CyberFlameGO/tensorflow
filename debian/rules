#!/usr/bin/make -f
export DEB_BUILD_MAINT_OPTIONS = hardening=+all
# mandatorily colorized output reduces burden to human eyes
export NINJA_STATUS="[1;31m[%es (%p) %f/%t][0;m "

LIBDIR=debian/tmp/usr/lib/$(DEB_HOST_MULTIARCH)/
SHELL=/bin/bash

%:
	dh $@ -Sninja -D.

override_dh_auto_clean:
	: # TODO

override_dh_auto_configure:
	$(SHELL) debian/dev configure # read code for detail
	$(SHELL) tensorflow/c/generate-pc.sh \
	   	-p usr -l lib/$(DEB_HOST_MULTIARCH) -v 2.0.0

override_dh_auto_build:
	python3 debian/fakebazel.py
	dh_auto_build -- -f libtensorflow_framework.ninja tensorflow/libtensorflow_framework.so
	$(SHELL) debian/dev gen_cc_ops
	dh_auto_build -- -f libtensorflow.ninja tensorflow/libtensorflow.so
	dh_auto_build -- -f libtensorflow_cc.ninja tensorflow/libtensorflow_cc.so
	#dh_auto_build -- -f pippackage.gen.ninja

override_dh_auto_test:
	: # TODO

override_dh_auto_install:
	$(SHELL) debian/dev install_headers debian/tmp/usr/include/
	mkdir -p $(LIBDIR)
	install -vm0644 tensorflow/libtensorflow_framework.so* $(LIBDIR)
	install -vm0644 tensorflow/libtensorflow.so* $(LIBDIR)
	install -vm0644 tensorflow/libtensorflow_cc.so* $(LIBDIR)
	install -vm0644 tensorflow.pc debian/tmp/usr/lib/$(DEB_HOST_MULTIARCH)/pkgconfig/tensorflow.pc
	install -vm0644 tensorflow_cc.pc debian/tmp/usr/lib/$(DEB_HOST_MULTIARCH)/pkgconfig/tensorflow_pc.pc
